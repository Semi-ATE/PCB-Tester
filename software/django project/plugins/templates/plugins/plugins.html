{% extends "index/base.html" %}
{% block content %}
<h1>Detect Plugin</h1>
    <article class="media content-section">
      <div class="media-body" id="divID">
        <div class="article-metadata">
          <input type="button" class="btn btn-outline-info" id="detectloadplugin" name="detectloadplugin" value="Detect and load plugin" />
          <input type="button" class="btn btn-outline-info" id="runtest" name="runtest" value="Run test" />
          <input type="button" class="btn btn-outline-info" id="update" name="update" value="Update plugins" />
        </div>
        <div class="article-metadata" id="result_text">
        Results:
        </div>
      </div>
    </article>

{% endblock content %}
{% block javascript %}
<script>
const states = {
    ready: 'ready',
    sending: 'sending'
};
let state = states.ready;
let currentajaxcall = null;
let pluginname = null;

function isMessagePending(){
    if(state==states.ready){
        return false;
    }else if(state==states.sending){
        return true;
    }else{
        return true;
    }
}
function sendAjax(type){
console.log(isMessagePending());
    if(!isMessagePending()){
        state=states.sending;
        console.log("send ajax request")
        currentajaxcall = $.ajax({
            type: "POST",
            url: "{% url 'pluginsajax' %}",
            data: {'csrfmiddlewaretoken': '{{ csrf_token }}', 
                'type': type,
                'pluginname': pluginname},
            dataType: "json",
            success: function(response) {
                state=states.ready;
                var div = document.getElementById('result_text');
                div.innerHTML += "<br /> Status: "+response.status+"; Message: "+response.message;
                pluginname = response.pluginname
            },
            error: function(rs, e) {
                state=states.ready;
                var div = document.getElementById('result_text');
                div.innerHTML += "<br />An error occurred ";
            }
        });
    }
}


function abortAjax(){
    console.log("abort")
    if(currentajaxcall!=null && state==states.sending){
        currentajaxcall.abort();
        console.log("aborted")
    }
}

window.addEventListener('beforeunload', function (e) {
  // the absence of a returnValue property on the event will guarantee the browser unload happens
  abortAjax();
  delete e['returnValue'];
});
$("#detectloadplugin").click(function () {
console.log("Trying to send")
    sendAjax("detectloadplugin");
});

$("#runtest").click(function () {
    var div = document.getElementById('result_text');
    div.innerHTML += "<br /> Message: Trying to run plugin";
    sendAjax("runtest");
});
$("#update").click(function () {
    var div = document.getElementById('result_text');
    sendAjax("update");
});
</script>
{% endblock javascript %}
